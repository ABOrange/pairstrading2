# 加密貨幣配對交易機器人

<div align="center">
  <img src="https://img.shields.io/badge/Spring%20Boot-3.4.5-brightgreen" alt="Spring Boot"/>
  <img src="https://img.shields.io/badge/Java-17-blue" alt="Java"/>
  <img src="https://img.shields.io/badge/Binance%20API-3.1.0-yellow" alt="Binance API"/>
  <img src="https://img.shields.io/badge/Pairs%20Trading-Statistical%20Arbitrage-orange" alt="Pairs Trading"/>
</div>

## 📖 專案概述

這是一個基於Spring Boot架構的加密貨幣配對交易機器人，專為在幣安永續合約市場進行統計套利交易而設計。系統採用先進的統計方法自動分析相關資產的價格關係，識別價格偏離的套利機會，並執行交易以獲取潛在利潤。

### 🌟 核心特點

- **全自動化交易**: 從市場數據分析到交易執行的完整自動化流程
- **風險管理**: 內建風險控制機制，包括倉位規模和槓桿倍率管理，以及爆倉風險評估
- **Web儀表板**: 直觀的用戶界面，監控交易狀態、查看圖表和管理設置
- **彈性配置**: 可自定義交易對、分析窗口大小、入場/出場閾值等參數
- **回測系統**: 完整的回測功能，包括套利次數統計和爆倉風險評估
- **完整日誌**: 詳細記錄所有交易活動和系統操作，便於分析和審計
- **測試環境支持**: 完全兼容幣安測試網，便於安全演練和策略測試
- **自動化BaseURL設定**: 根據測試網絡開關自動設定適當的API基礎URL，簡化配置流程

## 💹 配對交易策略

### 核心原理

配對交易（Pairs Trading）是一種統計套利策略，基於兩個相關資產價格關係的均值回歸特性。當兩個資產的價格關係偏離正常範圍時，交易者可以賣出高估資產並買入低估資產，待價格關係回歸均值時獲利。

### 分析方法

1. **選擇資產對**: 選擇兩個高相關性的加密貨幣（例如BTC和ETH）
2. **建立統計模型**:
   - 使用線性回歸（OLS）計算兩資產的最佳擬合關係（Alpha和Beta係數）
   - 計算價差（Spread）= 資產1價格 - (Alpha + Beta * 資產2價格)
   - 使用ADF檢定確認價差的平穩性
   - 計算價差的均值和標準差
   - 計算Z分數 = (當前價差 - 均值) / 標準差
3. **生成交易信號**:
   - Z分數 > 入場閾值: 做空資產1，做多資產2（資產1相對高估）
   - Z分數 < -入場閾值: 做多資產1，做空資產2（資產1相對低估）
   - |Z分數| < 出場閾值: 平倉所有倉位（價格關係回歸正常範圍）

### 風險控制

- **動態倉位調整**: 根據相關性強度和Z分數偏離程度調整倉位大小
- **槓桿風險管理**: 
  - 基於維持保證金率自動計算爆倉閾值 (維持保證金率 = 0.8 / 槓桿倍數)
  - 回測期間爆倉風險評估和統計
  - 根據槓桿值動態調整風險控制參數
- **套利效率評估**: 通過回測統計套利次數和成功率，評估策略效能
- **平穩性檢驗**: 使用ADF檢定確保價差序列具有均值回歸特性
- **多重參數驗證**: 確保交易參數符合交易所限制

## 🏗️ 系統架構

### 主要模組

#### 1. 配對交易核心服務 (PairsTradingService)

- 獲取市場數據並進行統計分析
- 計算相關性、回歸係數和Z分數
- 生成交易信號和監控圖表
- 執行交易策略邏輯

#### 2. 回測分析服務 (BackTestingService)

- 執行單一交易對及批量交易對回測
- 計算並統計回測期間的套利次數
- 基於槓桿評估爆倉風險並統計爆倉次數
- 提供回測結果的排序和篩選功能
- 產生綜合評分和交易對推薦

#### 3. 幣安API服務 (BinanceApiService)

- 對接幣安永續合約API
- 提供市場數據獲取（價格、K線等）
- 執行交易操作（下單、取消、平倉）
- 管理倉位和槓桿設定
- 處理交易參數調整（價格步長、數量精度）
- 支援自動切換測試網絡和正式網絡

#### 3. 排程與任務管理 (Quartz)

- 定時執行市場分析和交易策略
- 提供彈性的任務排程配置
- 支持手動觸發和監控任務執行狀態

#### 4. 資料持久化

- 使用JPA和Hibernate進行ORM映射
- H2數據庫存儲交易記錄和配置資訊
- 支持交易歷史和設定的持久化管理
- 配置參數從應用配置文件移至數據庫，支持動態修改

#### 5. Web控制台與儀表板

- Thymeleaf模板引擎實現的Web界面
- 提供直觀的圖表和交易數據顯示
- 支持交易參數配置和API設定管理
- 實時顯示交易信號和系統狀態
- 優化的設定頁面與用戶體驗

### 系統流程

1. **數據獲取**: 定時從幣安API獲取交易對K線數據
2. **統計分析**: 計算相關性、回歸係數、價差和Z分數
3. **信號生成**: 根據Z分數與閾值比較生成交易信號
4. **風險評估**: 根據相關性強度和Z分數調整倉位大小
5. **交易執行**: 根據信號執行相應的交易操作
6. **結果記錄**: 記錄交易結果、更新持倉歷史
7. **監控顯示**: 在Web儀表板顯示分析結果和交易狀態

## 🛠️ 技術實現

### 技術棧

- **後端**: Spring Boot 3.4.5, Java 17
- **資料庫**: H2 (嵌入式)
- **ORM**: Spring Data JPA, Hibernate
- **定時任務**: Quartz Scheduler
- **API**: RESTful API + 幣安API (binance-connector-java 3.1.0)
- **前端**: HTML5, Thymeleaf, JavaScript, CSS
- **數據分析**: Apache Commons Math3, Signaflo TimeSeries

### 核心技術點

1. **線性回歸與統計分析**
   - 使用SimpleRegression實現OLS回歸
   - 使用ADF檢定實現價差序列平穩性檢驗
   - 實現母體相關性計算與相關性分析
   - 採用擴大的交易窗口大小(700)提高算法穩定性

2. **資料處理與安全性**
   - 使用資料庫保存API金鑰而非配置檔案，提高安全性
   - 使用策略模式適配不同交易對的特性
   - 實現資料異常處理和資料校驗機制
   - 自動化設定API基礎URL，減少人為配置錯誤

3. **交易執行精度控制**
   - 實現價格步長(tick size)和數量精度自動調整
   - 處理名義價值(notional)最小限制
   - 實現訂單狀態監控和異常處理

4. **資源管理與優化**
   - 使用Quartz實現彈性的任務排程
   - 實現HTTP連接池管理和資源釋放
   - 採用延遲加載和資料緩存提高性能

## 💻 使用指南

### 系統要求

- Java 17 或更高版本
- Maven 3.6 或更高版本
- 幣安API金鑰（可使用測試網）

### 快速開始

1. **克隆儲存庫**
   ```bash
   git clone https://github.com/yourusername/pairstrading.git
   cd pairstrading
   ```

2. **編譯專案**
   ```bash
   mvn clean package
   ```

3. **運行專案**
   ```bash
   java -jar target/pairstrading-0.0.1-SNAPSHOT.jar
   ```
   或
   ```bash
   mvn spring-boot:run
   ```

4. **訪問儀表板**
   - 打開瀏覽器，訪問 `http://localhost:8080`
   - 登入系統（初次使用預設帳號）

### 配置指南

1. **API配置**
   - 訪問 `/settings/api-config` 頁面
   - 輸入幣安API金鑰和密鑰
   - 選擇使用測試網絡或正式網絡（系統會自動設定BaseURL）
   - 測試連接確保API正常運行

2. **交易配置**
   - 訪問 `/settings/trading-config` 頁面
   - 設定交易對（例如：BTCUSDT 和 ETHUSDT）
   - 配置窗口大小（預設值已調整為700）
   - 設定入場/出場閾值
   - 設定倉位大小和槓桿倍率
   - 啟用/禁用實際交易功能

3. **排程配置**
   - 預設每20秒執行一次分析
   - 可在 `QuartzConfig.java` 中修改排程設定

### 儀表板使用

- **總覽頁面**: 顯示當前市場狀態、交易信號和持倉情況
- **圖表頁面**: 查看Z分數和價差的圖形化表示
- **回測分析**: 
  - 執行單一交易對或批量交易對回測
  - 檢視套利次數和爆倉次數統計
  - 根據相關性、套利次數、爆倉風險等篩選交易對
  - 獲取交易對推薦，根據綜合得分排序
- **持倉歷史**: 查看所有交易記錄和盈虧情況
- **交易日誌**: 查看系統操作記錄和交易執行記錄
- **系統日誌**: 查看詳細的系統運行日誌

## 📝 開發者指南

### 專案結構

```
pairstrading/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── andy/
│   │   │       └── crypto/
│   │   │           └── pairstrading/
│   │   │               └── bot/
│   │   │                   ├── config/         # 配置類
│   │   │                   ├── controller/     # API控制器
│   │   │                   ├── entity/         # 資料實體
│   │   │                   ├── pairstrading/   # 核心交易邏輯
│   │   │                   │   ├── config/     # 幣安相關配置
│   │   │                   │   ├── controller/ # 交易控制器
│   │   │                   │   ├── job/        # 排程任務
│   │   │                   │   └── service/    # 交易服務
│   │   │                   ├── repository/     # 資料訪問層
│   │   │                   ├── service/        # 業務服務層
│   │   │                   └── util/           # 工具類
│   │   └── resources/
│   │       ├── static/      # 靜態資源
│   │       ├── templates/   # Thymeleaf模板
│   │       ├── application.yml   # 應用配置
│   │       └── data.sql     # 初始化SQL
│   └── test/                # 測試代碼
├── .mvn/                    # Maven包裝器
├── data/                    # H2資料庫檔案
├── pom.xml                  # Maven依賴
└── README.md                # 專案說明
```

### 擴展指南

#### 添加新交易對

1. 修改`TradingConfigService`中的交易對相關配置
2. 更新Web界面中的交易對選擇選項
3. 測試新交易對的數據獲取和交易執行

#### 自定義交易策略

1. 實現`PairsTradingService`接口的新版本
2. 修改`calculateSignal()`方法以實現自定義信號邏輯
3. 在配置中啟用新的策略實現

#### 改進風險管理

1. 擴展`calculateQuantity()`方法增加更複雜的倉位計算
2. 添加止損機制到交易執行流程
3. 實現波動率監控和風險預警機制

## ⚠️ 注意事項

1. **測試環境**
   - 強烈建議先在幣安測試網進行測試
   - 切換測試網/正式網很簡單，在API設定頁面上使用切換開關
   - 系統會自動設定適當的API基礎URL
   - 測試網API地址: https://testnet.binancefuture.com

2. **資金安全**
   - 實盤環境使用前確保風險控制機制有效
   - 開始時使用較小的交易金額進行驗證
   - 定期備份數據庫和配置信息

3. **API限制**
   - 注意幣安API的請求頻率限制
   - 避免短時間內大量API調用
   - 實現錯誤重試機制和冷卻期

4. **市場風險**
   - 加密貨幣市場高度波動，策略可能在極端市場條件下失效
   - 定期評估和調整策略參數
   - 配合使用其他風險控制手段

## 📊 效能指標

- **最小延遲**: 從信號生成到訂單提交 < 500ms
- **成功率**: 在正常市場條件下Z分數回歸成功率 > 85%
- **API效率**: 支持每分鐘至少10次完整的分析和交易循環
- **資源佔用**: JVM內存佔用 < 512MB

## 🤝 貢獻指南

歡迎提交問題報告、功能請求和代碼貢獻！請查看我們的 [貢獻指南](CONTRIBUTING.md) 了解詳細流程和規範。

1. Fork本儲存庫
2. 創建功能分支: `git checkout -b feature/amazing-feature`
3. 提交更改: `git commit -m 'Add some amazing feature'`
4. 推送到分支: `git push origin feature/amazing-feature`
5. 開啟Pull Request

## 📜 授權協議

本專案採用 [Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0) 授權協議](LICENSE)。此授權允許他人自由地分享和修改本專案，但禁止用於商業目的。

## 🙏 致謝

- 感謝幣安提供API服務和測試網環境
- 特別感謝所有開源庫的貢獻者，本專案使用了多個優秀的開源工具
- 感謝所有為本專案提供反饋和建議的用戶